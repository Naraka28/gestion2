name: CI - Análisis, Seguridad y Deploy

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  build_and_analyze:
    runs-on: gestion

    steps:
      - name: Descargar repositorio
        uses: actions/checkout@v3

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 mypy pytest
          python3 -m pip install types-requests

      # --- ANÁLISIS ESTÁTICO ---
      - name: Ejecutar flake8 (convenciones)
        run: |
          echo "Ejecutando flake8..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Ejecutar mypy (tipado estático)
        run: |
          echo "Ejecutando mypy..."
          mypy . --ignore-missing-imports

      # --- PRUEBAS UNITARIAS ---
      - name: Ejecutar pruebas unitarias
        run: pytest --maxfail=1 --disable-warnings -q

      # --- SONARQUBE ---
      - name: Instalar Sonar Scanner
        run: |
          export SONAR_SCANNER_VERSION=7.2.0.5079
          export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux-x64
          curl --create-dirs -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux-x64.zip
          unzip -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
          export PATH=$SONAR_SCANNER_HOME/bin:$PATH
          echo "PATH=$PATH" >> $GITHUB_ENV

      - name: Ejecutar análisis SonarQube
        env:
          SONAR_SCANNER_OPTS: "-Xmx512m"
        run: |
          sonar-scanner \
            -Dsonar.projectKey=gestion_2 \
            -Dsonar.sources=. \
            -Dsonar.host.url=http://localhost:9000 \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}

      # --- ANÁLISIS DE SEGURIDAD (CodeQL) ---
      - name: Inicializar CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: Ejecutar análisis CodeQL
        uses: github/codeql-action/analyze@v3
        with:
          category: "security-analysis"

      - name: Crear artefacto (.zip)
        run: |
          mkdir -p artifacts
          zip -r artifacts/weather_app.zip . -x "*.git*" "__pycache__/*" "*.pytest_cache*" "artifacts/*"
      - name: Subir artefacto a JFrog Artifactory
        run: |
          curl -H "X-JFrog-Art-Api:${{ secrets.JFROG_TOKEN }}" \
            -T artifacts/weather_app.zip \
            "${{ secrets.JFROG_URL }}/weather_app/${{ github.run_number }}/weather_app.zip"

      # --- DOCKER ---
      - name: Verificar Docker
        run: |
          docker --version
          systemctl is-active --quiet docker || (echo "Docker no está activo" && exit 1)

      - name: Construir imagen Docker
        run: docker build -t weather-app:latest .

      - name: Desplegar contenedor
        run: |
          docker rm -f weather-app 2>/dev/null || true
          docker run -d --name weather-app -p 80:80 weather-app:latest

      - name: Healthcheck de la app
        run: |
          for i in {1..20}; do
            if curl -sf http://localhost:80/ >/dev/null; then
              echo "✅ App corriendo correctamente"
              exit 0
            fi
            echo "Esperando app... ($i)"
            sleep 2
          done
          echo "❌ La app no respondió en el puerto 80"
          docker logs --tail=50 weather-app || true
          exit 1
